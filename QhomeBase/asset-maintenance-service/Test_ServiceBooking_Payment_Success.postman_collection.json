{
  "info": {
    "name": "Test Service Booking Payment Success",
    "description": "Test API để giả lập thanh toán thành công cho service booking và tạo invoice",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "1. Tạo Service Booking (Chuẩn bị)",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{token}}",
            "description": "JWT token của user"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"serviceId\": \"{{serviceId}}\",\n  \"bookingDate\": \"2025-12-20\",\n  \"startTime\": \"09:00:00\",\n  \"endTime\": \"11:00:00\",\n  \"durationHours\": 2,\n  \"numberOfPeople\": 1,\n  \"purpose\": \"Test booking\",\n  \"termsAccepted\": true\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/api/asset-maintenance/bookings",
          "host": ["{{baseUrl}}"],
          "path": ["api", "asset-maintenance", "bookings"]
        },
        "description": "Tạo booking trước. Lưu bookingId và txnRef từ response."
      },
      "response": []
    },
    {
      "name": "2. Initiate Payment (Tạo txnRef)",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{token}}"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/api/asset-maintenance/bookings/{{bookingId}}/payment/initiate",
          "host": ["{{baseUrl}}"],
          "path": ["api", "asset-maintenance", "bookings", "{{bookingId}}", "payment", "initiate"]
        },
        "description": "Khởi tạo payment để có txnRef. Lưu transactionRef từ response."
      },
      "response": []
    },
    {
      "name": "3. Test Payment Success (BYPASS SIGNATURE)",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{token}}"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/api/asset-maintenance/bookings/{{bookingId}}/test-payment-success",
          "host": ["{{baseUrl}}"],
          "path": ["api", "asset-maintenance", "bookings", "{{bookingId}}", "test-payment-success"]
        },
        "description": "Endpoint test để giả lập thanh toán thành công (bypass signature validation). Yêu cầu: Booking phải có vnpayTransactionRef (từ step 2)."
      },
      "response": []
    },
    {
      "name": "4. VNPay Callback (Với Signature - Cần tính toán)",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{baseUrl}}/api/asset-maintenance/bookings/vnpay/return?vnp_Amount=2000000&vnp_BankCode=NCB&vnp_BankTranNo=VNP12345678&vnp_CardType=ATM&vnp_OrderInfo=SERVICE_BOOKING_GYM&vnp_PayDate=20251220100000&vnp_ResponseCode=00&vnp_TmnCode=95ECYPGX&vnp_TransactionNo=12345678&vnp_TransactionStatus=00&vnp_TxnRef={{transactionRef}}&vnp_SecureHash={{calculatedHash}}",
          "host": ["{{baseUrl}}"],
          "path": ["api", "asset-maintenance", "bookings", "vnpay", "return"],
          "query": [
            {
              "key": "vnp_Amount",
              "value": "2000000",
              "description": "Số tiền (đã nhân 100, ví dụ: 20000 VND = 2000000)"
            },
            {
              "key": "vnp_BankCode",
              "value": "NCB"
            },
            {
              "key": "vnp_BankTranNo",
              "value": "VNP12345678"
            },
            {
              "key": "vnp_CardType",
              "value": "ATM"
            },
            {
              "key": "vnp_OrderInfo",
              "value": "SERVICE_BOOKING_GYM"
            },
            {
              "key": "vnp_PayDate",
              "value": "20251220100000",
              "description": "Format: yyyyMMddHHmmss"
            },
            {
              "key": "vnp_ResponseCode",
              "value": "00",
              "description": "00 = thành công"
            },
            {
              "key": "vnp_TmnCode",
              "value": "95ECYPGX",
              "description": "Từ config VNPay"
            },
            {
              "key": "vnp_TransactionNo",
              "value": "12345678"
            },
            {
              "key": "vnp_TransactionStatus",
              "value": "00",
              "description": "00 = thành công"
            },
            {
              "key": "vnp_TxnRef",
              "value": "{{transactionRef}}",
              "description": "Transaction ref từ booking (vd: 1234567890_1234567890123)"
            },
            {
              "key": "vnp_SecureHash",
              "value": "{{calculatedHash}}",
              "description": "Cần tính toán bằng HMAC SHA512. Dùng tool online hoặc script để tính."
            }
          ]
        },
        "description": "Callback từ VNPay với signature hợp lệ. Cần tính vnp_SecureHash trước."
      },
      "response": []
    }
  ],
  "variable": [
    {
      "key": "baseUrl",
      "value": "http://localhost:8084",
      "type": "string"
    },
    {
      "key": "token",
      "value": "YOUR_JWT_TOKEN_HERE",
      "type": "string"
    },
    {
      "key": "bookingId",
      "value": "",
      "type": "string",
      "description": "Điền sau khi tạo booking"
    },
    {
      "key": "transactionRef",
      "value": "",
      "type": "string",
      "description": "Điền sau khi initiate payment (vd: 1234567890_1234567890123)"
    },
    {
      "key": "calculatedHash",
      "value": "",
      "type": "string",
      "description": "Tính toán từ các params (trừ vnp_SecureHash và vnp_SecureHashType)"
    },
    {
      "key": "serviceId",
      "value": "",
      "type": "string",
      "description": "ID của service cần booking"
    }
  ]
}
